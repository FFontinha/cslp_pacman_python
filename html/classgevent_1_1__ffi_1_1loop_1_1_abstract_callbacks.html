<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: gevent._ffi.loop.AbstractCallbacks Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('classgevent_1_1__ffi_1_1loop_1_1_abstract_callbacks.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-attribs">Public Attributes</a> &#124;
<a href="classgevent_1_1__ffi_1_1loop_1_1_abstract_callbacks-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">gevent._ffi.loop.AbstractCallbacks Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Note on CFFI objects, callbacks and the lifecycle of watcher objects.  
 <a href="classgevent_1_1__ffi_1_1loop_1_1_abstract_callbacks.html#details">More...</a></p>

<p>Inherits object.</p>

<p>Inherited by <a class="el" href="classgevent_1_1libev_1_1corecffi_1_1___callbacks.html">gevent.libev.corecffi._Callbacks</a>, and <a class="el" href="classgevent_1_1libuv_1_1loop_1_1___callbacks.html">gevent.libuv.loop._Callbacks</a>.</p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a319fcaaa90cbbe173aad550d43dcb30b"><td class="memItemLeft" align="right" valign="top"><a id="a319fcaaa90cbbe173aad550d43dcb30b"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>__init__</b> (self, ffi)</td></tr>
<tr class="separator:a319fcaaa90cbbe173aad550d43dcb30b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34ef2c22e05517bab3a4b6739ae04d3f"><td class="memItemLeft" align="right" valign="top"><a id="a34ef2c22e05517bab3a4b6739ae04d3f"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>from_handle</b> (self, handle)</td></tr>
<tr class="separator:a34ef2c22e05517bab3a4b6739ae04d3f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48b9030fe4b0002fbb3374bbe85b30c3"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classgevent_1_1__ffi_1_1loop_1_1_abstract_callbacks.html#a48b9030fe4b0002fbb3374bbe85b30c3">python_callback</a> (self, handle, revents)</td></tr>
<tr class="separator:a48b9030fe4b0002fbb3374bbe85b30c3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a209765f784d867f41dfa3b667895e78d"><td class="memItemLeft" align="right" valign="top"><a id="a209765f784d867f41dfa3b667895e78d"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>python_handle_error</b> (self, handle, _revents)</td></tr>
<tr class="separator:a209765f784d867f41dfa3b667895e78d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae2a063345dc1921d7cffb0e0ecba829b"><td class="memItemLeft" align="right" valign="top"><a id="ae2a063345dc1921d7cffb0e0ecba829b"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>unhandled_onerror</b> (self, t, v, tb)</td></tr>
<tr class="separator:ae2a063345dc1921d7cffb0e0ecba829b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace30e9cf4f83010fef025c0b02956714"><td class="memItemLeft" align="right" valign="top"><a id="ace30e9cf4f83010fef025c0b02956714"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>python_stop</b> (self, handle)</td></tr>
<tr class="separator:ace30e9cf4f83010fef025c0b02956714"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac118d1dacf4d2bb69f476ba766a18722"><td class="memItemLeft" align="right" valign="top"><a id="ac118d1dacf4d2bb69f476ba766a18722"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>python_check_callback</b> (self, watcher_ptr)</td></tr>
<tr class="separator:ac118d1dacf4d2bb69f476ba766a18722"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac118d1dacf4d2bb69f476ba766a18722"><td class="memItemLeft" align="right" valign="top"><a id="ac118d1dacf4d2bb69f476ba766a18722"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>python_check_callback</b> (self, watcher_ptr)</td></tr>
<tr class="separator:ac118d1dacf4d2bb69f476ba766a18722"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2336869b4a35d0002266d0d5aa2d6a7e"><td class="memItemLeft" align="right" valign="top"><a id="a2336869b4a35d0002266d0d5aa2d6a7e"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>python_prepare_callback</b> (self, watcher_ptr)</td></tr>
<tr class="separator:a2336869b4a35d0002266d0d5aa2d6a7e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad70f66da1cd9f298de757a93dd760630"><td class="memItemLeft" align="right" valign="top"><a id="ad70f66da1cd9f298de757a93dd760630"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>check_callback_onerror</b> (self, t, v, tb)</td></tr>
<tr class="separator:ad70f66da1cd9f298de757a93dd760630"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr class="memitem:a09b25285f9a6e2446a44b15f1b5522e2"><td class="memItemLeft" align="right" valign="top"><a id="a09b25285f9a6e2446a44b15f1b5522e2"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>ffi</b></td></tr>
<tr class="separator:a09b25285f9a6e2446a44b15f1b5522e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa71949d30abd05f97bc0ca43f9cf58f2"><td class="memItemLeft" align="right" valign="top"><a id="aa71949d30abd05f97bc0ca43f9cf58f2"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>callbacks</b></td></tr>
<tr class="separator:aa71949d30abd05f97bc0ca43f9cf58f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a666ebdcd58a473f35ec7ca6b4305e1ca"><td class="memItemLeft" align="right" valign="top"><a id="a666ebdcd58a473f35ec7ca6b4305e1ca"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>from_handle</b></td></tr>
<tr class="separator:a666ebdcd58a473f35ec7ca6b4305e1ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Note on CFFI objects, callbacks and the lifecycle of watcher objects. </p>
<p>Each subclass of <code>watcher</code> allocates a C structure of the appropriate type e.g., struct gevent_ev_io and holds this pointer in its <code>_gwatcher</code> attribute. When that watcher instance is garbage collected, then the C structure is also freed. The C structure is passed to libev from the watcher's start() method and then to the appropriate C callback function, e.g., _gevent_ev_io_callback, which passes it back to python's _python_callback where we need the watcher instance. Therefore, as long as that callback is active (the watcher is started), the watcher instance must not be allowed to get GC'd&mdash;any access at the C level or even the FFI level to the freed memory could crash the process.</p>
<p>However, the typical idiom calls for writing something like this: loop.io(fd, python_cb).start() thus forgetting the newly created watcher subclass and allowing it to be immediately GC'd. To combat this, when the watcher is started, it places itself into the loop's <code>_keepaliveset</code>, and it only removes itself when the watcher's <code>stop()</code> method is called. Often, this is the <em>only</em> reference keeping the watcher object, and hence its C structure, alive.</p>
<p>This is slightly complicated by the fact that the python-level callback, called from the C callback, could choose to manually stop the watcher. When we return to the C level callback, we now have an invalid pointer, and attempting to pass it back to Python (e.g., to handle an error) could crash. Hence, _python_callback, _gevent_io_callback, and _python_handle_error cooperate to make sure that the watcher instance stays in the loops <code>_keepaliveset</code> while the C code could be running&mdash;and if it gets removed, to not call back to Python again. See also <a href="https://github.com/gevent/gevent/issues/676">https://github.com/gevent/gevent/issues/676</a> </p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a id="a48b9030fe4b0002fbb3374bbe85b30c3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48b9030fe4b0002fbb3374bbe85b30c3">&#9670;&nbsp;</a></span>python_callback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def gevent._ffi.loop.AbstractCallbacks.python_callback </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>revents</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Returns an integer having one of three values:

- -1
  An exception occurred during the callback and you must call
  :func:`_python_handle_error` to deal with it. The Python watcher
  object will have the exception tuple saved in ``_exc_info``.
- 1
  Everything went according to plan. You should check to see if the libev
  watcher is still active, and call :func:`python_stop` if it is not. This will
  clean up the memory. Finding the watcher still active at the event loop level,
  but not having stopped itself at the gevent level is a buggy scenario and
  shouldn't happen.
- 2
  Everything went according to plan, but the watcher has already
  been stopped. Its memory may no longer be valid.

This function should never return 0, as that's the default value that
Python exceptions will produce.
</pre> 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>venv/lib/python3.6/site-packages/gevent/_ffi/loop.py</li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>gevent</b></li><li class="navelem"><a class="el" href="namespacegevent_1_1__ffi.html">_ffi</a></li><li class="navelem"><a class="el" href="namespacegevent_1_1__ffi_1_1loop.html">loop</a></li><li class="navelem"><a class="el" href="classgevent_1_1__ffi_1_1loop_1_1_abstract_callbacks.html">AbstractCallbacks</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
